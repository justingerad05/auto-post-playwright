name: Test Medium Login (Stable Tunnel)

on:
  workflow_dispatch:

jobs:
  login:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Chromium headless on 0.0.0.0
        run: |
          echo "Starting Chromium..."
          export DISPLAY=:99

          chromium --headless \
            --remote-debugging-address=0.0.0.0 \
            --remote-debugging-port=9222 \
            --no-sandbox \
            --disable-gpu \
            --user-data-dir=/home/runner/chrome-profile \
            https://medium.com/m/signin &

          echo "Waiting for port 9222 to open..."

          for i in {1..30}; do
            if nc -z 127.0.0.1 9222; then
              echo "Chromium debug port is ready!"
              break
            fi
            echo "Still waiting..."
            sleep 1
          done

          if ! nc -z 127.0.0.1 9222; then
            echo "❌ Chromium never opened port 9222"
            exit 1
          fi

      - name: Install cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start Cloudflare Tunnel
        run: |
          echo "Starting Cloudflare Tunnel..."

          # ⚠️ FIX FOR YOUR ERROR
          # Force Cloudflare to treat origin as an IP, not a hostname
          cloudflared tunnel \
            --url http://127.0.0.1:9222 \
            --no-autoupdate \
            --logfile tunnel.log \
            2>&1 &

          sleep 8

          echo "=========== TUNNEL URL BELOW ==========="
          grep -o "https://[a-zA-Z0-9.-]*trycloudflare.com" tunnel.log || echo "❌ No tunnel URL yet"
          echo "========================================"

      - name: Keep alive
        run: |
          echo "Browser is LIVE. Use the tunnel URL to log in."
          while true; do
            echo "Still running..."
            sleep 30
          done
