name: Test Medium Login (Stable Tunnel)

on:
  workflow_dispatch:

jobs:
  login:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Chromium with Remote Debugging
        run: |
          echo "Starting Chromium..."
          export DISPLAY=:99
          chromium --headless --remote-debugging-address=0.0.0.0 --remote-debugging-port=9222 \
            --no-sandbox --disable-gpu --user-data-dir=/home/runner/chrome-profile \
            https://medium.com/m/signin &

          # Wait for Chromium to boot and open debugging port
          echo "Waiting for debug port..."
          for i in {1..30}; do
            if nc -z localhost 9222; then
              echo "Chromium debug port is ready!"
              break
            fi
            echo "Still waiting..."
            sleep 1
          done

          if ! nc -z localhost 9222; then
            echo "❌ Chromium did not open port 9222. Exiting."
            exit 1
          fi

      - name: Install cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start Cloudflare Tunnel
        run: |
          echo "Starting Cloudflare Tunnel..."
          cloudflared tunnel --url http://localhost:9222 --no-autoupdate --logfile tunnel.log > tunnel_output.log 2>&1 &
          sleep 8
          echo "=========== TUNNEL URL BELOW ==========="
          grep -o "https://[a-zA-Z0-9.-]*trycloudflare.com" tunnel_output.log || echo "❌ No tunnel URL found yet."
          echo "========================================"

      - name: Keep Alive
        run: |
          echo "Browser live! Use tunnel URL above to log in."
          while true; do
            echo "Still running..."
            sleep 30
          done
