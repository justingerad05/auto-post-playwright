name: Test Medium Login (Stable Tunnel)

on:
  workflow_dispatch:

jobs:
  login:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Start Cloudflare Tunnel
        run: |
          echo "Starting tunnel..."
          cloudflared tunnel --url http://localhost:9222 --no-autoupdate --logfile tunnel.log > tunnel_output.log 2>&1 &
          sleep 5
          echo "=========== TUNNEL URL BELOW ==========="
          grep -o "https://[a-zA-Z0-9.-]*trycloudflare.com" tunnel_output.log || true
          echo "========================================"

      - name: Start chromium with debugging port
        run: |
          export DISPLAY=:99
          chromium --remote-debugging-port=9222 --no-sandbox \
            --user-data-dir=/home/runner/chrome-profile \
            https://medium.com/m/signin &

          sleep 5

      - name: Keep Action alive
        run: |
          echo "Browser running. Do NOT close this Action."
          echo "Leave this tab open while you log in through the tunnel URL."
          while true; do
            echo "Still running..."
            sleep 30
          done
