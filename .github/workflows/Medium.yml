name: Run Medium Post

on:
  workflow_dispatch:

jobs:
  run-medium:
    runs-on: ubuntu-latest
    env:
      # optional: if you set USER_AGENT as repo secret, define it below
      USER_AGENT: ${{ secrets.USER_AGENT || '' }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Create chrome-profile directory
        run: |
          mkdir -p /tmp/chrome-profile

      - name: Decode CHROME_PROFILE_B64 and unzip
        if: ${{ secrets.CHROME_PROFILE_B64 != '' }}
        run: |
          echo "Decoding CHROME_PROFILE_B64 (this contains your profile ZIP base64)"
          printf "%s" "${{ secrets.CHROME_PROFILE_B64 }}" > /tmp/profile.b64
          base64 --decode /tmp/profile.b64 > /tmp/profile.zip || ( echo "base64 decode failed" && exit 1 )
          # unzip into /tmp/chrome-profile
          unzip -q /tmp/profile.zip -d /tmp/chrome-profile || ( echo "unzip failed" && exit 1 )
          # If your zip contained the profile folder name directly, ensure final path to be used:
          # the unzip may create /tmp/chrome-profile/Profile 1 or Default; we will handle in node script.

      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit || npm install --no-audit

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run automation
        env:
          CHROME_PROFILE_DIR: /tmp/chrome-profile
          # If you used a different secret name, set it here
          MEDIUM_POST_HTML: ${{ secrets.MEDIUM_POST_HTML || '' }}
          # USER_AGENT can be passed as secret if you set it
          USER_AGENT: ${{ secrets.USER_AGENT || '' }}
        run: |
          node main.mjs
