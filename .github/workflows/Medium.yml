name: Run Medium Post (manual)

on:
  workflow_dispatch:

jobs:
  run-medium-post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # -----------------------------
      # FIX 1: REMOVE LOCK FILE IF PRESENT
      # (prevents EINTEGRITY checksum failures)
      # -----------------------------
      - name: Remove package-lock.json if exists
        run: |
          if [ -f package-lock.json ]; then
            echo "Removing corrupted package-lock.json"
            rm package-lock.json
          fi

      # -------------------------------------------
      # FIX 2: RELIABLE NPM INSTALL (with RETRY)
      # -------------------------------------------
      - name: Install dependencies (with retry)
        run: |
          echo "Installing npm packages..."
          
          # First attempt
          npm install --no-audit --prefer-offline --no-fund || \
          (
            echo "First install failed. Retrying after clearing cache..."
            npm cache clean --force
            sleep 5
            npm install --no-audit --prefer-offline --no-fund
          )

      # -------------------------------------------
      # FIX 3: INSTALL PLAYWRIGHT BROWSER BINARIES
      # -------------------------------------------
      - name: Install Playwright Browsers
        run: |
          npx playwright install chromium

      # -------------------------------------------
      # FIX 4: RUN YOUR MAIN SCRIPT
      # -------------------------------------------
      - name: Run Medium Auto Post
        env:
          BROWSERLESS_WS: ${{ secrets.BROWSERLESS_WS }}
          BROWSERLESS_API_KEY: ${{ secrets.BROWSERLESS_API_KEY }}
          MEDIUM_COOKIES: ${{ secrets.MEDIUM_COOKIES }}
          USER_AGENT: ${{ secrets.USER_AGENT }}
          MEDIUM_FINGERPRINT: ${{ secrets.MEDIUM_FINGERPRINT }}
          MEDIUM_POST_HTML: ${{ secrets.MEDIUM_POST_HTML }}
        run: node main.mjs
